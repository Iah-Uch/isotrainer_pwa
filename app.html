<!doctype html>
<html lang="pt-br">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#010308" />
  <title>IsoTrainer</title>
  <!-- <link rel="manifest" href="/manifest.webmanifest" />
  <link rel="icon" href="/icons/logo_isotrainer.svg" sizes="192x192" type="image/png" /> -->
  <link rel="apple-touch-icon" href="/icons/logo_isotrainer.svg" />
  <!-- External libs (kept CDN for simplicity). If you have a bundler, self-host. -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- QR Scanner (ESM build also available; using global for simplicity) -->
  <script defer src="https://unpkg.com/qr-scanner@1.4.2/qr-scanner.umd.min.js" crossorigin="anonymous"
    referrerpolicy="no-referrer"></script>
  <link rel="stylesheet" href="./styles.css" />
</head>

<body class="min-h-svh text-slate-100 font-sans antialiased selection:bg-amber-600 selection:text-amber-100"
  shadow-[0_0_8px_#ffae00]/40 hover:shadow-[0_0_12px_#ffae00]/50 transition-all duration-200>
  <div id="appRoot" class="mx-auto w-full max-w-7xl p-3 sm:p-4 sm:py-0">
    <div class="rounded-2xl bg-[#101011] backdrop-blur-xl shadow-2xl" data-frame>
      <!-- TELA DE CONEXÃO -->
      <div id="connectScreen" class="hidden relative p-6">
        <div class="flex flex-col items-center gap-6">
          <h1 class="text-2xl font-semibold tracking-tight">
            Conecte seu
            <span class="text-amber-300">Dinamômetro</span>
          </h1>
          <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
            <button id="connectButton"
              class="px-5 py-2.5 rounded-xl bg-amber-600 hover:bg-amber-500 transition shadow-lg shadow-amber-500 disabled:bg-[#0b0b0c] disabled:cursor-not-allowed"
              shadow-[0_0_8px_#ffae00]/40 hover:shadow-[0_0_12px_#ffae00]/50 transition-all duration-200>
              Conectar ao dispositivo
            </button>
            <button id="disconnectButton" disabled
              class="px-5 py-2.5 rounded-xl bg-amber-700 hover:bg-amber-700 transition shadow-lg shadow-rose-600 disabled:bg-[#0b0b0c] disabled:cursor-not-allowed">
              Desconectar
            </button>
          </div>
          <div id="status" class="text-sm text-slate-300 text-center">
            Não conectado
          </div>
        </div>
      </div>

      <!-- TELA HOME (PLANOS) -->
      <div id="homeScreen" class="p-0">
        <div
          class="relative overflow-hidden rounded-2xl border border-[#2a2a2a] bg-gradient-to-br from-[#0f0f10] to-[#09090a]">
          <div class="p-6 sm:p-8">
            <div class="flex items-center justify-between gap-3">
              <div>
                <h2 class="text-2xl font-bold tracking-tight">Sessões</h2>
                <p id="homeSubtitle" class="text-slate-300">
                  Explore a biblioteca de mesociclos, importe periodizações ou use o fluxo manual.
                </p>
              </div>
              <div id="homeActions" class="flex flex-wrap items-center justify-end gap-2">
                <button id="homeManualBtn" class="px-3 py-2 rounded-xl bg-[#0b0b0c] hover:bg-[#0b0b0c]"
                  title="Fluxo manual">
                  Fluxo manual
                </button>
                <button id="importPlansBtn" class="px-3 py-2 rounded-xl bg-[#0b0b0c] hover:bg-[#0b0b0c] hidden"
                  title="Importar periodização">
                  Importar periodização
                </button>
                <button id="homeImportSessionBtn" class="px-3 py-2 rounded-xl bg-[#0b0b0c] hover:bg-[#0b0b0c] hidden"
                  title="Importar sessões concluídas">
                  Importar sessões
                </button>
                <input id="importPlansInput" type="file" accept=".csv,text/csv" class="hidden" />
                <input id="homeImportSessionInput" type="file" accept=".csv,text/csv" class="hidden" />
              </div>
            </div>
            <!-- Home FAB moved outside container below -->

            <div id="homeEmptyState" class="mt-12 grid place-items-center">
              <div class="text-center max-w-lg w-full px-4">
                <h3 class="text-xl font-semibold">
                  Importe sua periodização para começar
                </h3>
                <p class="mt-2 text-slate-300">
                  Solte o arquivo CSV aqui ou clique na área abaixo.
                </p>
                <div id="homeEmptyDropzone"
                  class="mt-6 rounded-2xl border-2 border-dashed border-[#2a2a2a] bg-[#101011] hover:bg-[#121213] transition p-8 cursor-pointer focus:outline-none focus:ring-2 focus:ring-amber-500">
                  <div class="flex flex-col items-center gap-3">
                    <div class="h-12 w-12 rounded-full bg-amber-600 text-amber-300 grid place-items-center"
                      shadow-[0_0_8px_#ffae00]/40 hover:shadow-[0_0_12px_#ffae00]/50 transition-all duration-200>
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"
                        aria-hidden="true">
                        <path d="M5 20h14v-2H5v2zM12 4l6 6h-4v6H10v-6H6l6-6z" />
                      </svg>
                    </div>
                    <div>
                      <div class="text-lg font-semibold">
                        Arraste e solte o arquivo CSV
                      </div>
                      <div class="text-sm text-slate-300">
                        ou clique para selecionar do seu dispositivo
                      </div>
                    </div>
                    <div class="text-xs text-slate-500">
                      Formatos aceitos: .csv
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div id="plansEmpty"
              class="hidden mt-3 rounded-xl border border-amber-400 bg-amber-600 p-3 text-amber-300 text-sm"
              shadow-[0_0_8px_#ffae00]/40 hover:shadow-[0_0_12px_#ffae00]/50 transition-all duration-200>
              Nenhuma periodização importada ainda. Importe seu arquivo para
              usar todas as funções do app.
            </div>

            <div id="homeContentWrap" class="mt-6">
              <div id="homeTabs" class="flex w-fit mx-auto rounded-xl overflow-hidden border border-[#2a2a2a]">
                <button id="tabFixed" class="hidden px-4 py-2 bg-[#0b0b0c]">
                  Planos fixos
                </button>
                <button id="tabTodo" class="px-4 py-2 bg-[#0b0b0c]">
                  A fazer
                </button>
                <button id="tabOverdue" class="px-4 py-2 bg-[#0b0b0c]">
                  Pendente
                </button>
                <button id="tabDone" class="px-4 py-2 bg-[#0b0b0c]">
                  Concluído
                </button>
              </div>

              <div id="panelFixed" class="mt-4 hidden">
                <div id="fixedPlansWrap" class="text-left">
                  <h3 class="text-lg font-semibold">Planos disponíveis</h3>
                  <p class="text-slate-300 text-sm mt-1">
                    Selecione um mesociclo para gerar estágios a partir da força máxima estimada do braço.
                  </p>
                  <div id="fixedPlansList" class="mt-4 grid gap-3 sm:grid-cols-2"></div>
                </div>
              </div>

              <!-- A FAZER: hoje e próximas -->
              <div id="panelTodo" class="mt-4">
                <h3 class="text-lg font-semibold mb-2">Sessão de hoje</h3>
                <div id="todayPlan" class="space-y-2"></div>
                <h3 class="text-lg font-semibold mt-6 mb-2">
                  Próximas sessões
                </h3>
                <div id="todoList" class="space-y-2"></div>
                <div id="todoPager" class="mt-3 flex items-center justify-center gap-2">
                  <button id="todoPagerPrev" class="px-3 py-1.5 rounded-xl bg-[#0b0b0c] hover:bg-[#0b0b0c]"
                    aria-label="Página anterior" title="Anterior">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"
                      aria-hidden="true">
                      <path d="M15 19l-7-7 7-7" />
                    </svg>
                  </button>
                  <div id="todoPagerInfo" class="text-sm text-slate-300">
                    —
                  </div>
                  <button id="todoPagerNext" class="px-3 py-1.5 rounded-xl bg-[#0b0b0c] hover:bg-[#0b0b0c]"
                    aria-label="Próxima página" title="Próxima">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"
                      aria-hidden="true">
                      <path d="M9 5l7 7-7 7" />
                    </svg>
                  </button>
                </div>
              </div>

              <!-- PENDENTE: atrasadas -->
              <div id="panelOverdue" class="mt-4 hidden">
                <div id="overdueList" class="space-y-2"></div>
                <div id="overduePager" class="mt-3 flex items-center justify-center gap-2">
                  <button id="overduePagerPrev" class="px-3 py-1.5 rounded-xl bg-[#0b0b0c] hover:bg-[#0b0b0c]"
                    aria-label="Página anterior" title="Anterior">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"
                      aria-hidden="true">
                      <path d="M15 19l-7-7 7-7" />
                    </svg>
                  </button>
                  <div id="overduePagerInfo" class="text-sm text-slate-300">
                    —
                  </div>
                  <button id="overduePagerNext" class="px-3 py-1.5 rounded-xl bg-[#0b0b0c] hover:bg-[#0b0b0c]"
                    aria-label="Próxima página" title="Próxima">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"
                      aria-hidden="true">
                      <path d="M9 5l7 7-7 7" />
                    </svg>
                  </button>
                </div>
              </div>

              <!-- CONCLUÍDO: finalizadas -->
              <div id="panelDone" class="mt-4 hidden">
                <div id="plansDoneList" class="space-y-2"></div>
                <div id="donePager" class="mt-3 flex items-center justify-center gap-2">
                  <button id="donePagerPrev" class="px-3 py-1.5 rounded-xl bg-[#0b0b0c] hover:bg-[#0b0b0c]"
                    aria-label="Página anterior" title="Anterior">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"
                      aria-hidden="true">
                      <path d="M15 19l-7-7 7-7" />
                    </svg>
                  </button>
                  <div id="donePagerInfo" class="text-sm text-slate-300">
                    —
                  </div>
                  <button id="donePagerNext" class="px-3 py-1.5 rounded-xl bg-[#0b0b0c] hover:bg-[#0b0b0c]"
                    aria-label="Próxima página" title="Próxima">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"
                      aria-hidden="true">
                      <path d="M9 5l7 7-7 7" />
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- PREVIEW MODAL (Sessão) moved outside container below -->

      <!-- TELA DE PLANO -->
      <div id="planScreen" class="hidden p-6">
        <div class="flex flex-col gap-3">
          <h2 class="text-xl font-semibold">
            Carregar plano de treino
            <span class="text-slate-300">(dispositivo necessário)</span>
          </h2>
          <textarea id="csvInput"
            class="w-full h-48 rounded-xl border border-[#2a2a2a] bg-[#101011] p-3 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-amber-500"
            placeholder="Cole aqui o plano separado por ponto e vírgula..."></textarea>
          <div id="csvError" class="hidden text-sm text-rose-400"></div>
          <div class="mt-2 flex items-center justify-between gap-2">
            <div class="flex items-center gap-2">
              <button id="scanQrBtn" title="Ler QR" aria-label="Ler QR"
                class="px-4 py-2 rounded-xl bg-amber-600 hover:bg-amber-500 transition flex items-center gap-2"
                shadow-[0_0_8px_#ffae00]/40 hover:shadow-[0_0_12px_#ffae00]/50 transition-all duration-200>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"
                  aria-hidden="true">
                  <path
                    d="M3 3h6v6H3V3zm2 2v2h2V5H5zM15 3h6v6h-6V3zm2 2v2h2V5h-2zM3 15h6v6H3v-6zm2 2v2h2v-2H5zM13 13h2v2h-2v-2zm4 0h4v2h-4v-2zm-4 4h2v4h-2v-4zm4 4h4v-2h-2v-2h-2v4z" />
                </svg>
                <span>Ler QR</span>
              </button>
            </div>
            <button id="loadCsvBtn"
              class="px-4 py-2 rounded-xl bg-amber-600 hover:bg-amber-500 transition shadow-lg shadow-amber-600"
              shadow-[0_0_8px_#ffae00]/40 hover:shadow-[0_0_12px_#ffae00]/50 transition-all duration-200>
              Carregar plano e iniciar
            </button>
          </div>
        </div>
      </div>

      <!-- TELA DE EDIÇÃO DO PLANO -->
      <div id="editPlanScreen" class="hidden p-6">
        <div class="mx-auto w-full max-w-2xl">
          <div class="flex items-center justify-between mb-3">
            <h2 class="text-xl font-semibold">Editar Sessão</h2>
          </div>
          <div class="mb-3 rounded-xl border border-rose-500 bg-amber-700 p-3 text-rose-200 shadow shadow-rose-900"
            role="alert" aria-live="polite">
            <div class="flex items-start gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mt-0.5 text-rose-300" viewBox="0 0 24 24"
                fill="currentColor" aria-hidden="true">
                <path d="M11 7h2v6h-2V7zm0 8h2v2h-2v-2z" />
                <path d="M1 21h22L12 2 1 21z" />
              </svg>
              <p class="text-sm">
                <span class="font-semibold">Aviso:</span>
                Esta tela de edição é um recurso experimental apenas para
                hard-users. Não estará disponível em futuras versões.
              </p>
            </div>
          </div>
          <div class="rounded-2xl border border-[#2a2a2a] bg-[#101011] p-3">
            <div
              class="flex flex-nowrap items-center gap-2 mb-2 overflow-x-auto whitespace-nowrap justify-start sm:justify-center btn-row-scroll">
              <button
                class="px-2 py-1 rounded-lg bg-[#0b0b0c] hover:bg-[#0b0b0c] disabled:bg-[#0b0b0c] disabled:opacity-30"
                data-act="adjTime" data-delta="-60">
                −1m
              </button>
              <button
                class="px-2 py-1 rounded-lg bg-[#0b0b0c] hover:bg-[#0b0b0c] disabled:bg-[#0b0b0c] disabled:opacity-30"
                data-act="adjTime" data-delta="-30">
                −30s
              </button>
              <button
                class="px-2 py-1 rounded-lg bg-[#0b0b0c] hover:bg-[#0b0b0c] disabled:bg-[#0b0b0c] disabled:opacity-30"
                data-act="adjTime" data-delta="-10">
                −10s
              </button>
              <button
                class="px-2 py-1 rounded-lg bg-[#0b0b0c] hover:bg-[#0b0b0c] disabled:bg-[#0b0b0c] disabled:opacity-30"
                data-act="adjTime" data-delta="-5">
                −5s
              </button>
              <button
                class="px-2 py-1 rounded-lg bg-[#0b0b0c] hover:bg-[#0b0b0c] disabled:bg-[#0b0b0c] disabled:opacity-30"
                data-act="adjTime" data-delta="5">
                +5s
              </button>
              <button
                class="px-2 py-1 rounded-lg bg-[#0b0b0c] hover:bg-[#0b0b0c] disabled:bg-[#0b0b0c] disabled:opacity-30"
                data-act="adjTime" data-delta="10">
                +10s
              </button>
              <button
                class="px-2 py-1 rounded-lg bg-[#0b0b0c] hover:bg-[#0b0b0c] disabled:bg-[#0b0b0c] disabled:opacity-30"
                data-act="adjTime" data-delta="30">
                +30s
              </button>
              <button
                class="px-2 py-1 rounded-lg bg-[#0b0b0c] hover:bg-[#0b0b0c] disabled:bg-[#0b0b0c] disabled:opacity-30"
                data-act="adjTime" data-delta="60">
                +1m
              </button>
            </div>
            <div class="flex items-center gap-2 mb-1">
              <label class="flex items-center gap-2 text-sm text-slate-200"><input id="editSelAll" type="checkbox"
                  class="accent-amber-600" />
                Selecionar todos</label>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-[13px]">
                <thead class="text-slate-200">
                  <tr>
                    <th class="py-1 pr-1 text-center"></th>
                    <th class="py-1 pr-1 text-center">Estágio</th>
                    <th class="py-1 pr-1 text-center">Duração</th>
                    <th class="py-1 pr-1 text-center">Inferior</th>
                    <th class="py-1 pr-1 text-center">Superior</th>
                  </tr>
                </thead>
                <tbody id="editPlanBody" class="align-top"></tbody>
              </table>
              <div class="text-xs text-slate-300 mb-2">
                Dica: selecione um ou mais estágios para ajustar a
                <span class="text-slate-200">duração</span> pelos botões
                acima. Edite os
                <span class="text-slate-200">limites</span> diretamente nos
                campos de cada linha.
              </div>
            </div>
            <div id="editPlanError" class="hidden mt-2 text-sm text-rose-400"></div>
          </div>
          <!-- Sticky footer actions -->
          <div
            class="sticky bottom-0 mt-4 bg-[#0b0b0c] backdrop-blur supports-[backdrop-filter]:bg-[#0b0b0c] rounded-xl border border-[#2a2a2a] p-3 flex items-center justify-between">
            <div class="text-xs text-slate-300">
              Revise as alterações antes de iniciar.
            </div>
            <div class="flex items-center gap-2">
              <button id="editBackBtn" class="px-3 py-2 rounded-xl bg-[#0b0b0c] hover:bg-[#0b0b0c]">
                Voltar
              </button>
              <button id="editStartBtn" class="px-4 py-2 rounded-xl bg-amber-600 hover:bg-amber-500"
                shadow-[0_0_8px_#ffae00]/40 hover:shadow-[0_0_12px_#ffae00]/50 transition-all duration-200>
                Iniciar sessão
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- PLOT SCREEN -->
      <div id="plotScreen" class="hidden p-3 sm:p-2 relative flex flex-col min-h-svh">
        <!-- Floating Action Button + Menu (top-right) -->
        <button id="viewSeriesFabToggle" class="fab fab-view hidden" aria-haspopup="true" aria-expanded="false"
          aria-controls="viewSeriesFabMenu" title="Selecionar série">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"
            aria-hidden="true">
            <path d="M4 6h16v2H4zm0 5h16v2H4zm0 5h10v2H4z" />
          </svg>
        </button>
        <div id="viewSeriesFabMenu" class="fab-menu fab-view-menu hidden" role="menu"
          aria-labelledby="viewSeriesFabToggle"></div>
        <button id="fabToggle" class="fab" aria-haspopup="true" aria-expanded="false" aria-controls="fabMenu"
          title="Ações">
          <!-- 3-dots icon -->
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"
            aria-hidden="true">
            <circle cx="5" cy="12" r="2"></circle>
            <circle cx="12" cy="12" r="2"></circle>
            <circle cx="19" cy="12" r="2"></circle>
          </svg>
        </button>
        <div id="fabMenu" class="fab-menu hidden" role="menu" aria-labelledby="fabToggle">
          <button class="fab-item flex items-center gap-2" data-act="play-pause" role="menuitem" title="Parar/Continuar"
            aria-label="Parar/Continuar">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"
              aria-hidden="true">
              <path d="M8 5h3v14H8zM13 5l8 7-8 7z" />
            </svg>
            <span>Parar/Continuar</span>
          </button>
          <button class="fab-item flex items-center gap-2" data-act="controls" role="menuitem" title="Controles"
            aria-label="Controles">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"
              aria-hidden="true">
              <path d="M7 4h2v16H7zM11 10h2v10h-2zM15 6h2v14h-2z" />
            </svg>
            <span>Controles de estágio</span>
          </button>
          <button class="fab-item flex items-center gap-2" data-act="back" role="menuitem" title="Voltar"
            aria-label="Voltar">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"
              aria-hidden="true">
              <path d="M15 19l-7-7 7-7" />
            </svg>
            <span>Voltar à Tela Inicial</span>
          </button>
        </div>
        <!-- Top header: single line (session • date • athlete • stage) -->
        <div id="plotHeader" class="flex items-center justify-center gap-2 text-xs text-slate-300">
          <span class="uppercase tracking-wide text-[.68rem]">Sessão</span>
          <span id="sessionMeta">—</span>
          <span class="mx-1">•</span>
          <span id="sessionAthlete">—</span>
          <span class="mx-1">•</span>
          <span id="stageLabel">Estágio —</span>
          <!-- Mobile-only live in-target % -->
          <span class="mx-1 only-mobile">•</span>
          <div id="stageInTargetPctMobileWrap" class="only-mobile inline-flex items-center gap-1 text-amber-300"
            title="No alvo (%)">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-3.5 w-3.5" fill="currentColor"
              aria-hidden="true">
              <path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm0 18a8 8 0 1 1 8-8 8.009 8.009 0 0 1-8 8Z" />
              <path d="M12 6a6 6 0 1 0 6 6A6.006 6.006 0 0 0 12 6Zm0 10a4 4 0 1 1 4-4 4.005 4.005 0 0 1-4 4Z" />
              <circle cx="12" cy="12" r="1.75" />
            </svg>
            <span id="stageInTargetPctMobile" class="font-semibold">—</span>
          </div>
        </div>

        <div id="frameGrid"
          class="grid w-full gap-2 sm:gap-4 grid-cols-1 landscape:grid-cols-[auto_1fr_auto] lg:grid-cols-[auto_1fr_auto] flex-1 min-h-0">
          <aside data-sidebar
            class="aside-left rounded-2xl border border-[#2a2a2a] bg-[#101011] p-3 sm:p-4 h-full grid place-items-center shrink-0 lg:w-48 xl:w-64 2xl:w-80">
            <div class="space-y-2">
              <div id="currentForce" class="text-center">
                <div id="currentForceValue" class="force-value font-bold text-amber-300 leading-none whitespace-nowrap">
                  --
                </div>
                <div class="force-unit tracking-wide text-slate-300 whitespace-nowrap">
                  kgf
                </div>
                <div id="stageRange" class="force-range font-semibold text-amber-300 whitespace-nowrap">
                  —
                </div>
                <!-- Next-stage hint appears after halfway point of current stage -->
                <div id="nextStageHint"
                  class="next-hint inline-flex items-center justify-center gap-1 text-amber-300 text-sm mt-2">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-3.5 w-3.5" fill="currentColor"
                    aria-hidden="true">
                    <path d="M8 5l8 7-8 7V5z" />
                  </svg>
                  <span id="nextStageRange" class="font-semibold">—</span>
                </div>
              </div>
            </div>
          </aside>

          <main id="plotStageCard" class="relative overflow-hidden h-full min-h-0">
            <div class="relative w-full h-full p-0 min-h-0">
              <div class="relative w-full h-full rounded-xl bg-[#0b0b0c] overflow-hidden">
                <div id="forceMarker" class="absolute left-0 top-0 z-20 opacity-0 force-pulse" style="
                      transform: translate(-50%, -50%);
                      --pulse-period: 1s;
                      pointer-events: none;
                    ">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" class="h-6 w-6 text-orange-400"
                    fill="currentColor" aria-hidden="true">
                    <path
                      d="M434.8 54.1C446.7 62.7 451.1 78.3 445.7 91.9L367.3 288L512 288C525.5 288 537.5 296.4 542.1 309.1C546.7 321.8 542.8 336 532.5 344.6L244.5 584.6C233.2 594 217.1 594.5 205.2 585.9C193.3 577.3 188.9 561.7 194.3 548.1L272.7 352L128 352C114.5 352 102.5 343.6 97.9 330.9C93.3 318.2 97.2 304 107.5 295.4L395.5 55.4C406.8 46 422.9 45.5 434.8 54.1z" />
                  </svg>
                </div>
                <div id="forceChart" class="absolute inset-0 w-full h-full"></div>
              </div>
            </div>
          </main>

          <aside data-sidebar
            class="aside-right rounded-2xl border border-[#2a2a2a] bg-[#101011] p-3 sm:p-2 grid place-items-center h-full shrink-0 lg:w-48 xl:w-64 2xl:w-80">
            <!-- Temporizadores maiores -->
            <div class="mt-1 grid grid-cols-1 gap-3">
              <div>
                <div class="text-[.68rem] uppercase tracking-wide text-slate-300">
                  Estágio
                </div>
                <div id="stageElapsed" class="timer-xl">00:00</div>
              </div>
              <div>
                <div class="text-[.68rem] uppercase tracking-wide text-slate-300">
                  Total
                </div>
                <div id="totalRemaining" class="timer-xl">00:00</div>
              </div>
              <div class="only-desktop">
                <div
                  class="target-pct-row text-[.68rem] uppercase tracking-wide text-slate-300 flex items-center justify-start sm:justify-start gap-1">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-4 w-4" fill="currentColor"
                    aria-hidden="true" title="No alvo (%)">
                    <path
                      d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm0 18a8 8 0 1 1 8-8 8.009 8.009 0 0 1-8 8Z" />
                    <path d="M12 6a6 6 0 1 0 6 6A6.006 6.006 0 0 0 12 6Zm0 10a4 4 0 1 1 4-4 4.005 4.005 0 0 1-4 4Z" />
                    <circle cx="12" cy="12" r="1.75" />
                  </svg>
                  <span class="sr-only">No alvo (%)</span>
                  <div id="stageInTargetPct" class="text-2xl text-amber-300">
                    —
                  </div>
                </div>
              </div>
            </div>
            <!-- Stage info moved to top header -->
            <!-- Keep original buttons for compatibility, but hide them (the FAB triggers them) -->
            <div class="hidden">
              <div class="flex items-center gap-2">
                <button id="playPauseBtn" aria-label="Pause training">
                  <svg id="iconPause" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20"
                    fill="currentColor">
                    <path fill-rule="evenodd" d="M5 4h3v12H5V4zm7 0h3v12h-3V4z" clip-rule="evenodd" />
                  </svg>
                  <svg id="iconPlay" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 hidden" viewBox="0 0 20 20"
                    fill="currentColor">
                    <path
                      d="M6.3 4.31A1 1 0 0 0 5 5.2v9.6a1 1 0 0 0 1.5.86l8.03-4.8a1 1 0 0 0 0-1.72l-8.03-4.8a1 1 0 0 0-1.2-.03z" />
                  </svg>
                </button>
                <button id="openControls" aria-haspopup="dialog" aria-controls="controlsModal">
                  Controles
                </button>
              </div>
              <button id="backButton">Voltar à Tela Inicial</button>
            </div>
          </aside>
        </div>

        <div id="sessionCardContainer" class="mt-2 sm:mt-4 rounded-2xl bg-[#101011] p-0">
          <div class="relative w-full h-[22svh] md:h-[24svh] min-h-[120px] rounded-xl bg-[#0b0b0c] overflow-hidden">
            <div id="sessionHrChart" class="absolute inset-0 w-full h-full"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Connect screen floating FABs (outside container) -->
  <div id="connectFabs" class="hidden">
    <button id="connectBackBtn"
      class="fixed bottom-6 left-4 z-30 h-14 w-14 rounded-full bg-[#0b0b0c] hover:bg-[#0b0b0c] text-white grid place-items-center shadow-lg"
      title="Voltar" aria-label="Voltar">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"
        aria-hidden="true">
        <path d="M15 19l-7-7 7-7" />
      </svg>
    </button>
    <button id="goToPlanButton" disabled
      class="fixed bottom-6 right-4 z-30 h-16 w-16 rounded-full bg-amber-600 hover:bg-amber-500 text-white grid place-items-center shadow-lg disabled:bg-[#0b0b0c] disabled:cursor-not-allowed"
      shadow-[0_0_8px_#ffae00]/40 hover:shadow-[0_0_12px_#ffae00]/50 transition-all duration-200
      title="Próximo: Carregar plano" aria-label="Próximo: Carregar plano">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 24 24" fill="currentColor"
        aria-hidden="true">
        <path d="M10 6l6 6-6 6-1.5-1.5L12 12 8.5 7.5 10 6z" />
      </svg>
    </button>
  </div>

  <!-- Inline Preview Modal (Sessão) -->
  <div id="sessionPreviewModal" class="hidden fixed inset-0 z-[60] overflow-y-auto bg-black/55 p-4" border
    border-[#2a2a2a] hover:border-[#ffae00]/30 transition-all duration-200 role="dialog" aria-modal="true">
    <div
      class="relative mx-auto mt-6 w-full max-w-md rounded-2xl border border-[#2a2a2a] bg-[#0b0b0c] ring-1 ring-[#2a2a2a] shadow-2xl">
      <div class="sticky top-0 z-10 bg-[#0b0b0c] backdrop-blur rounded-t-2xl border-[#2a2a2a] px-4 py-3 pb-0">
        <div class="flex items-center justify-end gap-2">
          <!-- <h3 class="text-lg font-semibold">Pré-visualização da sessão</h3> -->
          <div class="flex items-center gap-2">
            <button id="sessionPreviewClose" title="Fechar" aria-label="Fechar"
              class="h-9 w-9 grid place-items-center rounded-full bg-[#0b0b0c] hover:bg-[#0b0b0c]">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"
                aria-hidden="true">
                <path
                  d="M18.3 5.71L12 12l6.3 6.29-1.41 1.42L10.59 13.4 4.29 19.71 2.88 18.3 9.17 12 2.88 5.71 4.29 4.29 10.59 10.6l6.3-6.31z" />
              </svg>
            </button>
          </div>
        </div>
      </div>
      <div id="sessionPreviewBody" class="p-5 pt-3 min-h-[6rem]"></div>
      <div class="sticky bottom-0 z-10 bg-[#0b0b0c] backdrop-blur rounded-b-2xl border-[#2a2a2a] px-4 py-3 pt-0">
        <div class="flex items-center justify-between gap-3">
          <div class="flex items-center gap-2">
            <button id="sessionPreviewRenameBottom" title="Renomear" aria-label="Renomear"
              class="hidden h-11 w-11 grid place-items-center rounded-full bg-[#0b0b0c] hover:bg-[#0b0b0c]">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"
                aria-hidden="true">
                <path
                  d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.002 1.002 0 000-1.42l-2.34-2.34a1.002 1.002 0 00-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z" />
              </svg>
            </button>
            <button id="sessionPreviewDeleteBottom" title="Excluir" aria-label="Excluir"
              class="hidden h-11 w-11 grid place-items-center rounded-full bg-amber-700 hover:bg-amber-700">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"
                aria-hidden="true">
                <path d="M6 7h12l-1 12a2 2 0 01-2 2H9a2 2 0 01-2-2L6 7zm9-3l-1-1h-4l-1 1H5v2h14V4z" />
              </svg>
            </button>
          </div>
          <div class="flex items-center gap-2">
            <button id="sessionPreviewStart" title="Iniciar" aria-label="Iniciar"
              class="hidden h-11 w-11 grid place-items-center rounded-full bg-amber-600 hover:bg-amber-500"
              shadow-[0_0_8px_#ffae00]/40 hover:shadow-[0_0_12px_#ffae00]/50 transition-all duration-200>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"
                aria-hidden="true">
                <path d="M8 5v14l11-7z" />
              </svg>
            </button>
            <button id="sessionPreviewEdit" title="Editar" aria-label="Editar"
              class="hidden h-11 w-11 grid place-items-center rounded-full bg-[#0b0b0c] hover:bg-[#0b0b0c]">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"
                aria-hidden="true">
                <path
                  d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.002 1.002 0 000-1.42l-2.34-2.34a1.002 1.002 0 00-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z" />
              </svg>
            </button>
            <button id="sessionPreviewViewBottom" title="Ver" aria-label="Ver"
              class="hidden h-11 w-11 grid place-items-center rounded-full bg-amber-600 hover:bg-amber-500"
              shadow-[0_0_8px_#ffae00]/40 hover:shadow-[0_0_12px_#ffae00]/50 transition-all duration-200>
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"
                aria-hidden="true">
                <path
                  d="M12 5c-7.633 0-10 7-10 7s2.367 7 10 7 10-7 10-7-2.367-7-10-7zm0 12a5 5 0 115-5 5.006 5.006 0 01-5 5z" />
              </svg>
            </button>
            <button id="sessionPreviewDownloadBottom" title="Baixar CSV" aria-label="Baixar CSV"
              class="hidden h-11 w-11 grid place-items-center rounded-full bg-[#0b0b0c] hover:bg-[#0b0b0c]">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"
                aria-hidden="true">
                <path d="M5 20h14v-2H5v2zM19 9h-4V3H9v6H5l7 7 7-7z" />
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="fixedPlanModal" tabindex="-1"
    class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/55 p-4" border border-[#2a2a2a]
    hover:border-[#ffae00]/30 transition-all duration-200 role="dialog" aria-modal="true"
    aria-labelledby="fixedPlanTitle">
    <div
      class="w-full max-w-lg rounded-2xl border border-[#2a2a2a] bg-[#0b0b0c] ring-1 ring-[#2a2a2a] shadow-2xl flex flex-col gap-4 p-5">
      <div class="flex items-start justify-between gap-3">
        <div>
          <h3 id="fixedPlanTitle" class="text-xl font-semibold">Plano fixo</h3>
          <p id="fixedPlanSummary" class="mt-1 text-sm text-slate-200"></p>
        </div>
        <button id="fixedPlanCloseBtn" class="text-slate-200 hover:text-white text-2xl leading-none"
          aria-label="Fechar">
          ×
        </button>
      </div>
      <div class="text-sm text-slate-300" id="fixedPlanMeta">—</div>
      <div class="text-xs text-slate-500" id="fixedPlanMetaRest"></div>
      <ul id="fixedPlanStageList" class="space-y-2"></ul>
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-end gap-2">
        <button id="fixedPlanCancelBtn" class="px-4 py-2 rounded-lg bg-[#0b0b0c] hover:bg-[#0b0b0c] text-slate-200">
          Cancelar
        </button>
        <button id="fixedPlanStartBtn"
          class="px-4 py-2 rounded-lg bg-amber-600 hover:bg-amber-500 text-white font-medium"
          shadow-[0_0_8px_#ffae00]/40 hover:shadow-[0_0_12px_#ffae00]/50 transition-all duration-200>
          Iniciar fluxo
        </button>
      </div>
    </div>
  </div>

  <!-- Plan screen floating FABs (outside container) -->
  <div id="planFabs" class="hidden">
    <button id="backToConnect"
      class="fixed bottom-6 left-4 z-30 h-14 w-14 rounded-full bg-[#0b0b0c] hover:bg-[#0b0b0c] text-white grid place-items-center shadow-lg"
      title="Voltar" aria-label="Voltar">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"
        aria-hidden="true">
        <path d="M15 19l-7-7 7-7" />
      </svg>
    </button>
  </div>

  <!-- Home screen floating FABs (outside container) -->
  <div id="homeMenuWrap" class="hidden">
    <button id="homeMenuBtn"
      class="fixed bottom-6 right-4 z-40 h-14 w-14 rounded-full bg-amber-700 hover:bg-amber-600 text-white grid place-items-center shadow-lg"
      shadow-[0_0_8px_#ffae00]/40 hover:shadow-[0_0_12px_#ffae00]/50 transition-all duration-200 aria-haspopup="true"
      aria-expanded="false" aria-controls="homeMenu" title="Menu">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor"
        aria-hidden="true">
        <path d="M3 6h18v2H3zM3 11h18v2H3zM3 16h18v2H3z" />
      </svg>
    </button>
    <div id="homeMenu"
      class="hidden fixed bottom-24 right-4 z-50 w-56 rounded-xl border border-[#2a2a2a] bg-[#0b0b0c] shadow-xl p-2">
      <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-[#0b0b0c]" id="menuManual">
        Fluxo Manual
      </button>
      <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-[#0b0b0c]" id="menuImportPlan">
        Importar Periodização
      </button>
      <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-[#0b0b0c]" id="menuImportSession">
        Importar Sessões Conclúidas
      </button>
      <div class="my-1 h-px bg-[#121213]"></div>
      <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-[#0b0b0c]" id="menuSettings">
        Configurações
      </button>
      <div class="my-1 h-px bg-[#121213]"></div>
      <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-[#0b0b0c]" id="menuExportAll">
        Exportar Sessões Concluídas (CSV)
      </button>
      <button class="w-full text-left px-3 py-2 rounded-lg hover:bg-amber-700 text-rose-300" id="menuResetApp">
        Resetar Aplicação
      </button>
    </div>
  </div>

  <!-- Completion Screen -->
  <div id="completeScreen" class="hidden fixed inset-0 z-40 p-6 flex items-center justify-center bg-black/55" border
    border-[#2a2a2a] hover:border-[#ffae00]/30 transition-all duration-200>
    <div class="relative mx-auto w-full max-w-xl rounded-2xl border border-[#2a2a2a] bg-[#0b0b0c] p-6 shadow-2xl">
      <button id="completeMinimizeIcon" class="absolute top-3 right-3 text-slate-200 hover:text-white" title="Minimizar"
        aria-label="Minimizar">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="currentColor"
          aria-hidden="true">
          <path d="M5 19h14v2H5z" />
        </svg>
      </button>
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-full bg-amber-600 grid place-items-center text-amber-400"
          shadow-[0_0_8px_#ffae00]/40 hover:shadow-[0_0_12px_#ffae00]/50 transition-all duration-200>
          ✓
        </div>
        <h2 class="text-xl font-semibold">Sessão concluída</h2>
      </div>
      <p class="mt-2 text-slate-200">
        Bom trabalho! Aqui estão os destaques da sessão.
      </p>
      <div class="mt-4 grid grid-cols-2 gap-3 text-sm">
        <div class="rounded-xl bg-[#101011] p-3">
          <div class="text-slate-300">Força média</div>
          <div id="statAvg" class="text-2xl font-semibold">—</div>
        </div>
        <div class="rounded-xl bg-[#101011] p-3">
          <div class="text-slate-300">Força máxima</div>
          <div id="statMax" class="text-2xl font-semibold">—</div>
        </div>
        <div class="rounded-xl bg-[#101011] p-3">
          <div class="text-slate-300">Força mínima</div>
          <div id="statMin" class="text-2xl font-semibold">—</div>
        </div>
        <div class="rounded-xl bg-[#101011] p-3">
          <div class="text-slate-300">No alvo</div>
          <div id="statInTarget" class="text-2xl font-semibold">—</div>
        </div>
      </div>
      <div id="completeActions" class="mt-4 grid grid-cols-3 gap-2">
        <button id="completeBackBtn" class="w-full px-4 py-2 rounded-xl bg-[#0b0b0c] hover:bg-[#0b0b0c]">
          Voltar à Tela Inicial
        </button>
        <button id="completeExportBtn"
          class="w-full px-4 py-2 rounded-xl bg-[#0b0b0c] hover:bg-[#0b0b0c] flex items-center justify-center gap-2"
          title="Exportar CSV" aria-label="Exportar CSV">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"
            aria-hidden="true">
            <path d="M5 20h14v-2H5v2zM19 9h-4V3H9v6H5l7 7 7-7z" />
          </svg>
          <span>CSV</span>
        </button>
        <button id="completePlanBtn" class="w-full px-4 py-2 rounded-xl bg-amber-600 hover:bg-amber-500"
          shadow-[0_0_8px_#ffae00]/40 hover:shadow-[0_0_12px_#ffae00]/50 transition-all duration-200>
          Carregar novo plano
        </button>
      </div>
    </div>
  </div>

  <!-- Completion Restore FAB -->
  <button id="completeRestoreFab"
    class="hidden fixed bottom-24 right-4 z-40 h-14 w-14 rounded-full bg-amber-600 hover:bg-amber-500 text-white shadow-lg grid place-items-center"
    shadow-[0_0_8px_#ffae00]/40 hover:shadow-[0_0_12px_#ffae00]/50 transition-all duration-200 title="Ver resumo"
    aria-label="Ver resumo">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
      <path d="M9 12l2 2 4-4 1.5 1.5L11 17 7.5 13.5 9 12z" />
    </svg>
  </button>

  <!-- Controls Modal -->
  <div id="controlsModal" class="hidden fixed inset-0 z-50 items-center justify-center bg-black/55 p-4" border
    border-[#2a2a2a] hover:border-[#ffae00]/30 transition-all duration-200 role="dialog" aria-modal="true"
    aria-labelledby="controlsTitle">
    <div class="w-full max-w-sm rounded-2xl border border-[#2a2a2a] bg-[#0b0b0c] p-4 ring-1 ring-[#2a2a2a]">
      <div class="flex items-center justify-between">
        <h3 id="controlsTitle" class="text-lg font-semibold">
          Controles de estágio
        </h3>
        <button id="closeControls" class="text-slate-200 hover:text-white text-2xl leading-none" aria-label="Fechar">
          ×
        </button>
      </div>
      <div class="mt-4 grid grid-cols-2 gap-2">
        <button id="prevStageBtn" class="rounded-xl bg-[#0b0b0c] hover:bg-[#0b0b0c] px-3 py-2">
          ◀ Anterior
        </button>
        <button id="nextStageBtn" class="rounded-xl bg-[#0b0b0c] hover:bg-[#0b0b0c] px-3 py-2">
          Próximo ▶
        </button>
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="hidden fixed inset-0 z-50 items-center justify-center bg-black/55 p-4 overflow-auto"
    border border-[#2a2a2a] hover:border-[#ffae00]/30 transition-all duration-200 role="dialog" aria-modal="true"
    aria-labelledby="settingsTitle">
    <div
      class="w-full max-w-md max-h-[88svh] overflow-auto rounded-2xl border border-[#2a2a2a] bg-[#0b0b0c] p-4 ring-1 ring-[#2a2a2a]">
      <div class="flex items-center justify-between">
        <h3 id="settingsTitle" class="text-lg font-semibold">
          Configurações
        </h3>
        <button id="settingsClose" class="text-slate-200 hover:text-white text-2xl leading-none" aria-label="Fechar">
          ×
        </button>
      </div>
      <div class="mt-4 space-y-3">
        <label class="flex items-center justify-between gap-3 p-3 rounded-xl bg-[#101011] border border-[#2a2a2a]">
          <div>
            <div class="font-medium">Modo de Alto Contraste</div>
          </div>
          <label class="switch"><input id="contrastToggle" type="checkbox" /><span class="slider"></span></label>
        </label>
        <label class="flex items-center justify-between gap-3 p-3 rounded-xl bg-[#101011] border border-[#2a2a2a]">
          <div>
            <div class="font-medium">Legacy Galileu Colors</div>
          </div>
          <label class="switch"><input id="legacyColorsToggle" type="checkbox" /><span class="slider"></span></label>
        </label>
        <label class="flex items-center justify-between gap-3 p-3 rounded-xl bg-[#101011] border border-[#2a2a2a]">
          <div>
            <div class="font-medium">Planos fixos na Home</div>
          </div>
          <label class="switch"><input id="fixedPlanToggle" type="checkbox" /><span class="slider"></span></label>
        </label>
        <!-- NEW: Auto-forward settings -->
        <label class="flex items-center justify-between gap-3 p-3 rounded-xl bg-[#101011] border border-[#2a2a2a]">
          <div>
            <div class="font-medium">Auto-skip na medição máxima</div>
          </div>
          <label class="switch"><input id="autoForwardMeasurementToggle" type="checkbox" /><span
              class="slider"></span></label>
        </label>
        <label class="flex items-center justify-between gap-3 p-3 rounded-xl bg-[#101011] border border-[#2a2a2a]">
          <div>
            <div class="font-medium">Auto-skip no pré-início</div>
          </div>
          <label class="switch"><input id="autoForwardPrestartToggle" type="checkbox" /><span
              class="slider"></span></label>
        </label>

        <!-- Plot Screen Settings -->
        <details class="rounded-xl bg-[#101011] border border-[#2a2a2a] p-3">
          <summary class="font-medium cursor-pointer select-none">
            Elementos da tela de Plot
          </summary>
          <div class="text-sm text-slate-300 mb-2">
            Desative/ative elementos individuais do gráfico.
          </div>
          <div class="space-y-2">
            <label class="flex items-center justify-between gap-3 p-2 rounded-lg bg-[#0e0e0f]">
              <span>Topo: Sessão</span>
              <label class="switch"><input id="togglePlotHeaderSession" type="checkbox" /><span
                  class="slider"></span></label>
            </label>
            <label class="flex items-center justify-between gap-3 p-2 rounded-lg bg-[#0e0e0f]">
              <span>Topo: Atleta</span>
              <label class="switch"><input id="togglePlotHeaderAthlete" type="checkbox" /><span
                  class="slider"></span></label>
            </label>
            <label class="flex items-center justify-between gap-3 p-2 rounded-lg bg-[#0e0e0f]">
              <span>Topo: Estágio</span>
              <label class="switch"><input id="togglePlotHeaderStageLabel" type="checkbox" /><span
                  class="slider"></span></label>
            </label>
            <label class="flex items-center justify-between gap-3 p-2 rounded-lg bg-[#0e0e0f]">
              <span>Topo: No alvo (mobile)</span>
              <label class="switch"><input id="togglePlotHeaderInTargetMobile" type="checkbox" /><span
                  class="slider"></span></label>
            </label>

            <label class="flex items-center justify-between gap-3 p-2 rounded-lg bg-[#0e0e0f]">
              <span>Lateral Esq.: Força atual</span>
              <label class="switch"><input id="toggleAsideLeftForceValue" type="checkbox" /><span
                  class="slider"></span></label>
            </label>
            <label class="flex items-center justify-between gap-3 p-2 rounded-lg bg-[#0e0e0f]">
              <span>Lateral Esq.: Unidade N</span>
              <label class="switch"><input id="toggleAsideLeftForceUnit" type="checkbox" /><span
                  class="slider"></span></label>
            </label>
            <label class="flex items-center justify-between gap-3 p-2 rounded-lg bg-[#0e0e0f]">
              <span>Lateral Esq.: Intervalo do estágio</span>
              <label class="switch"><input id="toggleAsideLeftStageRange" type="checkbox" /><span
                  class="slider"></span></label>
            </label>
            <label class="flex items-center justify-between gap-3 p-2 rounded-lg bg-[#0e0e0f]">
              <span>Lateral Esq.: Dica próximo estágio</span>
              <label class="switch"><input id="toggleAsideLeftNextHint" type="checkbox" /><span
                  class="slider"></span></label>
            </label>

            <label class="flex items-center justify-between gap-3 p-2 rounded-lg bg-[#0e0e0f]">
              <span>Gráfico: Marcador de força</span>
              <label class="switch"><input id="toggleForceMarker" type="checkbox" /><span class="slider"></span></label>
            </label>
            <label class="flex items-center justify-between gap-3 p-2 rounded-lg bg-[#0e0e0f]">
              <span>Gráfico: Estágio (linha)</span>
              <label class="switch"><input id="toggleStageChart" type="checkbox" /><span class="slider"></span></label>
            </label>
            <label class="flex items-center justify-between gap-3 p-2 rounded-lg bg-[#0e0e0f]">
              <span>Gráfico: suavização de tendência</span>
              <label class="switch"><input id="toggleTrendSmoothing" type="checkbox" /><span
                  class="slider"></span></label>
            </label>
            <label class="flex items-center justify-between gap-3 p-2 rounded-lg bg-[#0e0e0f]">
              <span>Força da suavização</span>
              <div class="flex items-center gap-2">
                <input id="trendSmoothingAlpha" type="range" min="0.02" max="0.95" step="0.02" value="0.02"
                  class="w-32" />
                <span id="trendSmoothingAlphaValue" class="text-sm text-slate-200">0.02</span>
              </div>
            </label>
            <label class="flex items-center justify-between gap-3 p-2 rounded-lg bg-[#0e0e0f]">
              <span>Suavização no modo de visualização</span>
              <label class="switch"><input id="toggleViewingModeSmoothing" type="checkbox" /><span
                  class="slider"></span></label>
            </label>

            <label class="flex items-center justify-between gap-3 p-2 rounded-lg bg-[#0e0e0f]">
              <span>Lateral Dir.: Cronômetro do estágio</span>
              <label class="switch"><input id="toggleAsideRightStageElapsed" type="checkbox" /><span
                  class="slider"></span></label>
            </label>
            <label class="flex items-center justify-between gap-3 p-2 rounded-lg bg-[#0e0e0f]">
              <span>Lateral Dir.: Tempo total</span>
              <label class="switch"><input id="toggleAsideRightTotalRemaining" type="checkbox" /><span
                  class="slider"></span></label>
            </label>
            <label class="flex items-center justify-between gap-3 p-2 rounded-lg bg-[#0e0e0f]">
              <span>Lateral Dir.: No alvo (%)</span>
              <label class="switch"><input id="toggleAsideRightInTarget" type="checkbox" /><span
                  class="slider"></span></label>
            </label>

            <label class="flex items-center justify-between gap-3 p-2 rounded-lg bg-[#0e0e0f]">
              <span>Gráfico inferior: Sessão (linha)</span>
              <label class="switch"><input id="toggleSessionChart" type="checkbox" /><span
                  class="slider"></span></label>
            </label>
          </div>
        </details>

        <details class="rounded-xl bg-[#101011] border border-[#2a2a2a] p-3">
          <summary class="font-medium cursor-pointer select-none">
            Descansos entre etapas
          </summary>
          <div class="space-y-3 mt-3 text-sm">
            <label class="flex items-center justify-between gap-3 p-2 rounded-lg bg-[#0e0e0f]">
              <div>
                <div class="font-medium text-slate-200">Duração do descanso (s)</div>
                <div class="text-xs text-slate-300">Aplicado a cada descanso configurado.</div>
              </div>
              <input id="restIntervalInput" type="number" min="10" max="600" step="10"
                class="w-24 rounded-md border border-[#2a2a2a] bg-[#0b0b0c] px-2 py-1 text-right" />
            </label>

            <label class="flex items-center justify-between gap-3 p-2 rounded-lg bg-[#0e0e0f]">
              <div>
                <div class="font-medium text-slate-200">Permitir pular descanso</div>
                <div class="text-xs text-slate-300">Exibe o botão “Pular descanso” durante a contagem.</div>
              </div>
              <label class="switch"><input id="restSkipToggle" type="checkbox" /><span class="slider"></span></label>
            </label>

            <div class="rounded-lg bg-[#0e0e0f] p-3">
              <div class="font-medium text-slate-200">Descansos configurados</div>
              <div class="text-xs text-slate-300 mt-1">
                Reordene as séries (a primeira de cada braço inclui a medição de força máxima) e insira descansos nos
                pontos desejados.
              </div>
              <ul id="restPositionsList" class="mt-2 space-y-2"></ul>
              <button id="restAddBtn"
                class="mt-2 w-full rounded-lg border border-dashed border-[#2a2a2a] px-3 py-2 text-sm text-slate-200 hover:bg-[#101011]">
                Adicionar descanso
              </button>
            </div>
          </div>
        </details>

        <div class="rounded-xl bg-[#101011] border border-[#2a2a2a] p-3">
          <div class="font-medium">Multiplicadores das Laterais</div>
          <div class="space-y-2 mt-2">
            <label class="flex items-center justify-between gap-3 p-2 rounded-lg bg-[#0e0e0f]">
              <div>
                <div class="font-medium">Multiplicador Lateral Esquerda</div>
                <div class="text-xs text-slate-300">
                  Ajusta o tamanho dos elementos (0 = sem ajuste)
                </div>
              </div>
              <input id="asideLeftMul" type="number" step="0.1" min="-0.9" max="3" value="0"
                class="w-24 text-black rounded-md px-2 py-1" />
            </label>
            <label class="flex items-center justify-between gap-3 p-2 rounded-lg bg-[#0e0e0f]">
              <div>
                <div class="font-medium">Multiplicador Lateral Direita</div>
                <div class="text-xs text-slate-300">
                  Ajusta o tamanho dos elementos (0 = sem ajuste)
                </div>
              </div>
              <input id="asideRightMul" type="number" step="0.1" min="-0.9" max="3" value="0"
                class="w-24 text-black rounded-md px-2 py-1" />
            </label>
          </div>
        </div>

        <div class="mt-3 flex items-center justify-between gap-2">
          <button id="settingsResetAll" class="px-4 py-2 rounded-lg bg-amber-700 hover:bg-amber-700 text-white">
            Restaurar padrões
          </button>
          <div class="flex-1"></div>
          <button id="settingsSaveBtn" class="px-4 py-2 rounded-lg bg-amber-600 hover:bg-amber-500 text-white"
            shadow-[0_0_8px_#ffae00]/40 hover:shadow-[0_0_12px_#ffae00]/50 transition-all duration-200>
            Salvar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- (pre-start flow removed) -->

  <!-- Arm Maximum Measurement Modal -->
  <div id="armMaxModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/55 p-4" border
    border-[#2a2a2a] hover:border-[#ffae00]/30 transition-all duration-200 role="dialog" aria-modal="true"
    aria-labelledby="armMaxTitle">
    <div class="w-full max-w-md rounded-2xl border border-[#2a2a2a] bg-[#0b0b0c] p-5 ring-1 ring-[#2a2a2a] space-y-4">
      <div>
        <h3 id="armMaxTitle" class="text-xl font-semibold">Medição de força máxima</h3>
        <p id="armMaxSubtitle" class="text-sm text-slate-300 mt-1">
          Mantenha o braço em posição e aplique força máxima por 3 segundos.
        </p>
      </div>
      <div class="grid grid-cols-2 gap-3 text-sm">
        <div class="rounded-xl bg-[#101011] p-3">
          <div class="text-slate-300 text-xs">Força atual</div>
          <div id="armMaxCurrent" class="text-2xl font-semibold">0,0 kgf</div>
        </div>
        <div class="rounded-xl bg-[#101011] p-3">
          <div class="text-slate-300 text-xs">Máximo capturado</div>
          <div id="armMaxPeak" class="text-2xl font-semibold">0,0 kgf</div>
        </div>
      </div>
      <div class="rounded-xl bg-[#101011] p-3">
        <div class="text-slate-300 text-xs">Progresso da captura</div>
        <div class="mt-2 h-2 rounded-full bg-[#0b0b0c]">
          <div id="armMaxProgress" class="h-2 rounded-full bg-amber-600 transition-all" shadow-[0_0_8px_#ffae00]/40
            hover:shadow-[0_0_12px_#ffae00]/50 transition-all duration-200 style="width: 0%"></div>
        </div>
        <div id="armMaxCountdown" class="mt-2 text-sm text-slate-200">3,0s restantes</div>
      </div>
      <div class="flex items-center justify-end gap-2">
        <button id="armMaxCancelBtn" class="px-4 py-2 rounded-lg bg-[#0b0b0c] hover:bg-[#0b0b0c] text-slate-200">
          Cancelar
        </button>
        <button id="armMaxProceedBtn"
          class="px-4 py-2 rounded-lg bg-amber-600 hover:bg-amber-500 text-white disabled:bg-[#0b0b0c] disabled:text-slate-300"
          shadow-[0_0_8px_#ffae00]/40 hover:shadow-[0_0_12px_#ffae00]/50 transition-all duration-200 disabled>
          Prosseguir
        </button>
      </div>
    </div>
  </div>

  <!-- Pre-Start Modal -->
  <div id="preStartModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/70 p-4"
    role="dialog" aria-modal="true" aria-labelledby="preStartTitle">
    <div class="w-full max-w-sm rounded-2xl border border-[#2a2a2a] bg-[#0b0b0c] p-5 ring-1 ring-[#2a2a2a]">
      <h3 id="preStartTitle" class="text-xl font-semibold">
        Prepare-se para começar
      </h3>
      <p class="mt-2 text-sm text-slate-300">
        Antes de iniciar, ajuste a intensidade para entrar no intervalo do 1º
        estágio. Você pode começar mesmo fora do alvo, se preferir.
      </p>
      <div class="mt-4 grid grid-cols-2 gap-2 text-sm">
        <div class="rounded-xl bg-[#101011] p-3">
          <div class="text-slate-300 text-xs">Alvo (E1)</div>
          <div id="preStartStageRange" class="text-lg font-semibold">—</div>
        </div>
        <div class="rounded-xl bg-[#101011] p-3">
          <div class="text-slate-300 text-xs">Sua força</div>
          <div id="preStartForceValue" class="text-lg font-semibold">—</div>
        </div>
      </div>
      <div class="mt-3">
        <div class="relative h-3 rounded-full bg-slate-700" id="preStartBar" aria-hidden="true">
          <div id="preStartTarget" class="absolute h-3 rounded-full" style="background:rgb(0 171 76);left: 0; width: 0">
          </div>
          <div id="preStartThumb"
            class="absolute -top-1 h-5 w-5 rounded-full border-2 border-white bg-current text-slate-400"
            style="left: 0"></div>
        </div>
        <div class="flex items-center justify-between text-xs text-slate-400 mt-1">
          <span id="preStartScaleMin">—</span>
          <span id="preStartScaleMax">—</span>
        </div>
      </div>
      <div id="preStartGuidance" class="mt-3 text-sm text-slate-300 flex items-center gap-2" aria-live="polite">
        <span id="preStartIcon" class="inline-flex h-5 w-5 items-center justify-center text-slate-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"
            aria-hidden="true">
            <path d="M12 2a10 10 0 1 0 10 10A10.011 10.011 0 0 0 12 2Zm0 18a8 8 0 1 1 8-8 8.009 8.009 0 0 1-8 8Z" />
          </svg>
        </span>
        <span id="preStartText">Aguardando leitura de força...</span>
      </div>
      <div class="mt-4 flex items-center justify-end gap-2">
        <button id="preStartBackBtn"
          class="px-4 py-2 rounded-lg bg-[#0b0b0c] hover:bg-[#0b0b0c] text-slate-200">
          Cancelar
        </button>
        <button id="preStartGoBtn"
          class="px-4 py-2 rounded-lg bg-amber-600 hover:bg-amber-500 text-white disabled:bg-[#0b0b0c] disabled:text-slate-300 flex items-center gap-2"
          disabled>
          Iniciar
          <span id="preStartCountdown" class="ml-2 text-xs text-slate-300 hidden"></span>
        </button>
      </div>
    </div>
  </div>

  <!-- Rest Countdown Overlay -->
  <div id="restOverlay" class="hidden fixed inset-0 z-40 flex items-center justify-center bg-black/55 p-4" border
    border-[#2a2a2a] hover:border-[#ffae00]/30 transition-all duration-200 role="dialog" aria-modal="true"
    aria-live="polite">
    <div
      class="w-full max-w-sm rounded-2xl border border-[#2a2a2a] bg-[#0b0b0c] p-5 ring-1 ring-[#2a2a2a] space-y-4 text-center">
      <div class="text-sm uppercase tracking-wide text-slate-300">Descanso</div>
      <div id="restCountdown" class="text-4xl font-semibold">02:00</div>
      <div id="restNextInfo" class="text-sm text-slate-300"></div>
      <button id="restSkipBtn"
        class="hidden w-full rounded-lg bg-amber-600 hover:bg-amber-500 px-4 py-2 text-white disabled:bg-[#0b0b0c]"
        shadow-[0_0_8px_#ffae00]/40 hover:shadow-[0_0_12px_#ffae00]/50 transition-all duration-200>
        Pular descanso
      </button>
    </div>
  </div>

  <!-- QR Scan Modal -->
  <div id="qrModal" class="hidden fixed inset-0 z-50 items-center justify-center bg-black/55 p-4" border
    border-[#2a2a2a] hover:border-[#ffae00]/30 transition-all duration-200>
    <div
      class="w-full max-w-md rounded-2xl border border-[#2a2a2a] bg-[#0b0b0c] p-4 ring-1 ring-[#2a2a2a] flex flex-col gap-3">
      <div class="flex items-center justify-between">
        <h3 class="text-lg font-semibold">Ler QR do plano de treino</h3>
        <button id="closeQr" class="text-slate-200 hover:text-white text-2xl leading-none" aria-label="Fechar">
          ×
        </button>
      </div>
      <video id="qrVideo" class="w-full aspect-[4/3] bg-black/55 rounded-xl" border border-[#2a2a2a]
        hover:border-[#ffae00]/30 transition-all duration-200 muted playsinline></video>
      <div id="qrHint" class="text-sm text-slate-300">
        Aponte a câmera para o QR code
      </div>
      <div id="qrError" class="hidden text-sm text-rose-400"></div>
      <div class="flex items-center justify-between gap-2">
        <!-- <button id="qrRetry" disabled class="px-4 py-2 rounded-xl bg-[#0b0b0c] hover:bg-[#0b0b0c]">Ler
          novamente</button> -->
      </div>
    </div>
  </div>

  <script type="module" src="./js/main.js"></script>
  <script type="module" src="./js/ui-fab.js"></script>
  <script type="module" src="./js/edit-plan.js"></script>
  <script type="module" src="./js/qr.js"></script>
  <script type="module" src="./js/pwa.js"></script>
  <script>
    // Viewing mode smoothing toggle
    document.addEventListener("DOMContentLoaded", function () {
      const toggle = document.getElementById("toggleViewingModeSmoothing");
      if (toggle && window.state) {
        // Load persisted setting
        const persisted = localStorage.getItem("isotrainer:viewingModeSmoothingEnabled");
        if (persisted !== null) {
          window.state.viewingModeSmoothingEnabled = persisted === "true";
        }
        toggle.checked = !!window.state.viewingModeSmoothingEnabled;
        // Apply on load
        if (typeof window.applyTrendSmoothingSetting === "function") {
          window.applyTrendSmoothingSetting(window.state.viewingModeSmoothingEnabled);
        }
        if (typeof window.refreshStageSeriesForSmoothing === "function") {
          window.refreshStageSeriesForSmoothing();
        }
        if (typeof window.plotStageSliceByIndex === "function" && window.state && typeof window.state.stageIdx === "number") {
          window.plotStageSliceByIndex(window.state.stageIdx);
        }
        // On toggle
        toggle.addEventListener("change", function () {
          window.state.viewingModeSmoothingEnabled = !!toggle.checked;
          localStorage.setItem("isotrainer:viewingModeSmoothingEnabled", window.state.viewingModeSmoothingEnabled ? "true" : "false");
          if (typeof window.applyTrendSmoothingSetting === "function") {
            window.applyTrendSmoothingSetting(window.state.viewingModeSmoothingEnabled);
          }
          if (typeof window.refreshStageSeriesForSmoothing === "function") {
            window.refreshStageSeriesForSmoothing();
          }
          if (typeof window.plotStageSliceByIndex === "function" && window.state && typeof window.state.stageIdx === "number") {
            window.plotStageSliceByIndex(window.state.stageIdx);
          }
        });
      }
    });
  </script>
  <script type="module">
    import { enableWakeLock } from "./js/wake-lock.js";
    // Enable wake lock as early as possible
    enableWakeLock();
  </script>

  <script>
    // PWA Service Worker registration
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => {
        navigator.serviceWorker.register("/sw.js").catch(() => {
          /* noop */
        });
      });
    }
  </script>
</body>

</html>
